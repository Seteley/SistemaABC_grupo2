WITH costo_actividad AS (
    -- Calcula el costo total de cada actividad por centro y período
    SELECT
        ia.cod_actividad,
        c.codigo AS cod_centro,
        ia.cod_inductor,
        SUM(rp.monto) AS total_recurso_centro,
        ia.porcentaje,
        (SUM(rp.monto) * ia.porcentaje / 100) AS costo_actividad
    FROM
        inductor_actividad ia
    JOIN actividad a ON ia.cod_actividad = a.codigo
    JOIN recurso r ON r.cod_prorrateo = ia.cod_inductor
    JOIN recurso_periodo rp ON rp.cod_recurso = r.codigo AND rp.fecha_periodo = ia.fecha_periodo
    JOIN centro c ON a.cod_centro = c.codigo
    WHERE ia.fecha_periodo = '2024-12-01'  -- ajusta el período si quieres
    GROUP BY
        ia.cod_actividad,
        c.codigo,
        ia.cod_inductor,
        ia.porcentaje
)

SELECT
    ca.cod_actividad,
    ao.cod_objeto,
    ao.porcentaje AS porcentaje_objeto,
    ca.costo_actividad,
    (ca.costo_actividad * ao.porcentaje / 100) AS costo_objeto_por_actividad
FROM
    costo_actividad ca
JOIN actividad_objeto ao ON ca.cod_actividad = ao.cod_actividad AND ao.fecha_periodo = '2024-12-01'
ORDER BY
    ca.cod_actividad,
    ao.cod_objeto;
